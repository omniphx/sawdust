## Codebase Patterns
- Marquee selection uses a 2D HTML overlay div over the R3F Canvas; camera is exposed via CameraExposer component + ref
- `getBoxScreenBounds()` projects all 8 corners of a box to screen space, returns { left, top, right, bottom } AABB; marquee uses AABB intersection
- Selection state uses `selectedBoxIds: string[]` array (not single ID) — always use `selectBoxes([id])` for single select, `selectBoxes([])` to deselect
- Clipboard is `Box[] | null` — always store/paste arrays, even for single items
- State management is in `src/store/projectStore.tsx` using React Context + useReducer pattern
- `getActiveBoxes(state)` returns boxes from either project or component-builder mode
- `setActiveBoxes(state, boxes)` sets boxes in the correct mode context
- Box position is corner-based (bottom-left-front), not center-based
- `duplicateBoxGroup(sourceBoxes, existingBoxes)` duplicates/pastes a group preserving relative positions; finds non-overlapping placement for the entire group
- ESLint config is not set up (v9 migration needed), so `npm run lint` fails — use `npm run build` for quality checks (includes tsc)
- Multi-drag uses `dragStartPositions` ref to record initial positions of all selected boxes on pointer down; delta is computed from dragged box's start pos
- When clicking an already-selected box in a multi-selection: don't replace selection on pointer down (to allow drag); replace on pointer up if no drag occurred
- Auto-stacking has been removed from both single-box and multi-box drag handlers (US-002/US-003)
- `groupIdToColor(groupId)` in Box3D.tsx hashes a UUID to a hue for consistent group coloring
- Group/Ungroup toolbar buttons only appear when selection meets criteria (2+ for group, any with groupId for ungroup)
- `groupId` is optional on Box — `undefined` means not grouped, a shared UUID string means grouped together
- Group-aware selection: Box3D computes `groupMemberIds` from `allBoxes` with same `groupId`; `onSelectGroup(ids)` and `onToggleSelectGroup(ids)` handle expanding selection to group members
- `duplicateBoxGroup` maps old groupIds to new UUIDs so duplicated groups stay grouped with fresh IDs
- `onSelect` prop was removed from Box3D — use `onSelectGroup([id])` for single select (handles both grouped and ungrouped boxes)
- `locked` is optional on Box (default `undefined`/falsy) — TOGGLE_LOCK action uses "if any unlocked, lock all; else unlock all" logic
- Lock icon overlay uses `Html` from `@react-three/drei` positioned at the top-right corner of the box
- Toolbar Lock button appears when any box is selected; styled amber when all selected are locked
- Toast notifications use `state.toastMessage` + `SHOW_TOAST`/`DISMISS_TOAST` actions; `Toast` component in `src/components/ui/Toast.tsx` auto-dismisses after 2 seconds
- Locked box drag prevention: check `box.locked` in `handlePointerDown` before starting drag; for multi-drag, exclude locked boxes from `dragStartPositions`
- Locked box delete prevention: `deleteSelectedBoxes` in store filters out locked boxes and shows toast warning
- Undo/redo uses `projectReducerWithHistory` wrapper around `projectReducer` — automatically snapshots boxes after any `BOX_MUTATING_ACTIONS`
- `history: Box[][]` and `historyIndex: number` in state — not persisted to IndexedDB, resets on page reload
- UNDO/REDO actions restore boxes from history snapshot and clear selection
- `SET_PROJECT` (load from DB) resets history to `[loadedBoxes]` with index 0
- Undo/redo toolbar buttons use `canUndo`/`canRedo` from store for disabled state; keyboard shortcuts Cmd+Z and Shift+Cmd+Z in App.tsx
- R3F pointer events (Box3D) and HTML mouse events (marquee on container div) are separate event systems — `stopPropagation` doesn't cross between them. Use a shared mutable ref (`pointerCapturedByBox`) to coordinate: set in R3F onPointerDown, check in HTML onMouseDown

---

## 2026-02-14 - US-001
- Implemented: Fixed `getSnapIncrement()` to return `0.0254` (1 inch in meters) when `unitSystem` is `'inches'`, instead of falling through to the `0.3048` (1 foot) default
- Files changed: `src/core/units.ts`
- **Learnings for future iterations:**
  - `getSnapIncrement` and `snapToGrid` work together — the increment feeds into `snapToGrid` which rounds to the nearest multiple
  - The fix was a simple conditional branch addition; feet/inches were previously sharing the same return value
---

## 2026-02-15 - US-002
- Implemented: Removed auto-stacking from single-box drag in Box3D.tsx
- Removed the `stackY` calculation loop (lines 179-192) that checked for XZ overlap with other boxes and computed stacking Y
- Now uses `box.position.y` (pre-drag Y position) instead of computed `stackY`
- Files changed: `src/components/viewport/Box3D.tsx`
- **Learnings for future iterations:**
  - Auto-stacking logic exists in two places in Box3D: single-box drag (~line 177) and multi-box drag (~line 142). US-003 will handle the multi-box version.
  - The drag handler uses `box.position.y` which reflects the current position since React re-renders during drag with updated props
---

## 2026-02-15 - US-003
- Implemented: Removed auto-stacking from multi-box drag in Box3D.tsx
- Removed the `stackY` calculation loop that checked XZ overlap with non-dragged boxes
- Now uses `startPos.y` (from `dragStartPositions` map) to maintain each box's pre-drag Y position
- Also removed unused `draggedIds` Set since it was only used for the stacking exclusion
- Files changed: `src/components/viewport/Box3D.tsx`
- **Learnings for future iterations:**
  - Both auto-stacking loops (single and multi) are now removed. No more auto-stacking in drag handlers.
---

## 2026-02-15 - US-004 & US-005
- Implemented: Created `getBoxScreenBounds()` function and updated marquee hit testing to use AABB intersection
- `getBoxScreenBounds()` projects all 8 corners of a box's 3D bounding box to screen space and returns axis-aligned bounding rect
- Replaced center-point containment check with AABB intersection: `marquee.left <= box.right AND marquee.right >= box.left AND marquee.top <= box.bottom AND marquee.bottom >= box.top`
- Removed old `getBoxScreenPosition()` function (no longer needed)
- Files changed: `src/components/viewport/Viewport.tsx`
- **Learnings for future iterations:**
  - R3F WebGL interactions (pointer events, raycasting) don't work in headless Chrome — can't fully test marquee/click selection via Playwright
  - `getBoxScreenBounds` uses the same projection technique as the old `getBoxScreenPosition` but for all 8 corners instead of just the center
  - Shift+marquee toggle logic is unchanged — it uses a Set to add/remove from current selection
---

## 2026-02-14 - US-006
- Verified: Batch history support was already implemented in `src/store/projectStore.tsx`
- `HISTORY_BATCH_START` saves deep clone of boxes as `historyBatchAnchor` (lines 297-304)
- `HISTORY_BATCH_END` compares current boxes to anchor; if changed, pushes one history snapshot; clears anchor (lines 306-335)
- `projectReducerWithHistory` suppresses `UPDATE_BOX` history entries when `historyBatchAnchor` is non-null (lines 363-365)
- Non-batch mutating actions (ADD_BOX, DELETE_BOX, etc.) still create history entries immediately
- History capped at 50 entries via `MAX_HISTORY` constant
- `historyBatchStart()` and `historyBatchEnd()` exposed via context (lines 722-728)
- Build and typecheck pass
- Files changed: none (already implemented); only `prd.json` updated
- **Learnings for future iterations:**
  - The batch system specifically targets UPDATE_BOX suppression — other box-mutating actions still record history during a batch
  - HISTORY_BATCH_END replaces the history entry at current index with the anchor snapshot and pushes current state — this assumes no non-UPDATE_BOX mutations occurred during the batch
---
