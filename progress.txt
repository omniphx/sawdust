## Codebase Patterns
- Marquee selection uses a 2D HTML overlay div over the R3F Canvas; camera is exposed via CameraExposer component + ref
- Box screen positions computed with Vector3.project(camera) then mapped to container-relative coords
- Selection state uses `selectedBoxIds: string[]` array (not single ID) — always use `selectBoxes([id])` for single select, `selectBoxes([])` to deselect
- Clipboard is `Box[] | null` — always store/paste arrays, even for single items
- State management is in `src/store/projectStore.tsx` using React Context + useReducer pattern
- `getActiveBoxes(state)` returns boxes from either project or component-builder mode
- `setActiveBoxes(state, boxes)` sets boxes in the correct mode context
- Box position is corner-based (bottom-left-front), not center-based
- `duplicateBoxGroup(sourceBoxes, existingBoxes)` duplicates/pastes a group preserving relative positions; finds non-overlapping placement for the entire group
- ESLint config is not set up (v9 migration needed), so `npm run lint` fails — use `npm run build` for quality checks (includes tsc)
- Multi-drag uses `dragStartPositions` ref to record initial positions of all selected boxes on pointer down; delta is computed from dragged box's start pos
- When clicking an already-selected box in a multi-selection: don't replace selection on pointer down (to allow drag); replace on pointer up if no drag occurred
- Auto-stacking during multi-drag excludes other dragged boxes from collision checks
- `groupIdToColor(groupId)` in Box3D.tsx hashes a UUID to a hue for consistent group coloring
- Group/Ungroup toolbar buttons only appear when selection meets criteria (2+ for group, any with groupId for ungroup)
- `groupId` is optional on Box — `undefined` means not grouped, a shared UUID string means grouped together
- Group-aware selection: Box3D computes `groupMemberIds` from `allBoxes` with same `groupId`; `onSelectGroup(ids)` and `onToggleSelectGroup(ids)` handle expanding selection to group members
- `duplicateBoxGroup` maps old groupIds to new UUIDs so duplicated groups stay grouped with fresh IDs
- `onSelect` prop was removed from Box3D — use `onSelectGroup([id])` for single select (handles both grouped and ungrouped boxes)
- `locked` is optional on Box (default `undefined`/falsy) — TOGGLE_LOCK action uses "if any unlocked, lock all; else unlock all" logic
- Lock icon overlay uses `Html` from `@react-three/drei` positioned at the top-right corner of the box
- Toolbar Lock button appears when any box is selected; styled amber when all selected are locked
- Toast notifications use `state.toastMessage` + `SHOW_TOAST`/`DISMISS_TOAST` actions; `Toast` component in `src/components/ui/Toast.tsx` auto-dismisses after 2 seconds
- Locked box drag prevention: check `box.locked` in `handlePointerDown` before starting drag; for multi-drag, exclude locked boxes from `dragStartPositions`
- Locked box delete prevention: `deleteSelectedBoxes` in store filters out locked boxes and shows toast warning
- Undo/redo uses `projectReducerWithHistory` wrapper around `projectReducer` — automatically snapshots boxes after any `BOX_MUTATING_ACTIONS`
- `history: Box[][]` and `historyIndex: number` in state — not persisted to IndexedDB, resets on page reload
- UNDO/REDO actions restore boxes from history snapshot and clear selection
- `SET_PROJECT` (load from DB) resets history to `[loadedBoxes]` with index 0
- Undo/redo toolbar buttons use `canUndo`/`canRedo` from store for disabled state; keyboard shortcuts Cmd+Z and Shift+Cmd+Z in App.tsx

---

## 2026-02-14 - US-010
- What was implemented: Undo/redo history system in state management layer — tracks all box mutations with deep-cloned snapshots
- Files changed:
  - src/store/projectStore.tsx - Added `history`/`historyIndex` to state, `UNDO`/`REDO` action types, `projectReducerWithHistory` wrapper that auto-snapshots after box-mutating actions, `undo()`/`redo()`/`canUndo`/`canRedo` exposed from context, `SET_PROJECT` initializes history with loaded boxes
- **Learnings for future iterations:**
  - History wrapper pattern: `projectReducerWithHistory` calls `projectReducer` first, then checks if boxes changed via reference equality (`oldBoxes !== newBoxes`); if so, pushes deep clone to history
  - Deep clone includes spreading `position` and `dimensions` objects to prevent shared references
  - `BOX_MUTATING_ACTIONS` set defines which actions trigger history: ADD_BOX, DELETE_BOX, UPDATE_BOX, DUPLICATE_BOXES, PASTE_BOXES, DELETE_SELECTED_BOXES, GROUP_BOXES, UNGROUP_BOXES, TOGGLE_LOCK, PLACE_COMPONENT
  - New mutations after undo truncate redo stack: `history.slice(0, historyIndex + 1)` before pushing new snapshot
  - UNDO/REDO clear `selectedBoxIds` to avoid stale references to deleted/changed boxes
  - History is unlimited and session-only (not persisted) — auto-save always saves current state
---

## 2026-02-14 - US-009
- What was implemented: Enforced lock behavior — locked boxes cannot be dragged or deleted, with toast warnings
- Files changed:
  - src/components/ui/Toast.tsx - New component: auto-dismissing toast notification (red, 2-second duration, fade animation)
  - src/store/projectStore.tsx - Added `toastMessage` to state, `SHOW_TOAST`/`DISMISS_TOAST` actions, updated `deleteSelectedBoxes` to filter locked boxes and show warnings
  - src/components/viewport/Box3D.tsx - Added `onShowToast` prop, early return in `handlePointerDown` if box is locked, excluded locked boxes from multi-drag `dragStartPositions`
  - src/components/viewport/Viewport.tsx - Passes `showToast` from store as `onShowToast` to Box3D
  - src/App.tsx - Renders `Toast` component, passes `dismissToast` from store
- **Learnings for future iterations:**
  - Toast state lives in project store (not component-local) so any part of the app can trigger warnings
  - Locked drag prevention is at click time (handlePointerDown), not during move — prevents unnecessary work
  - Multi-drag with mixed locked/unlocked: only unlocked boxes are added to dragStartPositions, locked ones stay put
  - Delete with mixed locked/unlocked: unlocked are deleted, locked are kept, toast shows count of skipped items
---

## 2026-02-14 - US-006
- What was implemented: Added groupId field to Box type, GROUP_BOXES/UNGROUP_BOXES reducer actions, Group/Ungroup toolbar buttons, and colored outline visual indicator for grouped boxes
- Files changed:
  - src/types/index.ts - Added optional `groupId?: string` field to Box interface
  - src/store/projectStore.tsx - Added GROUP_BOXES and UNGROUP_BOXES action types, reducer cases, and `groupSelectedBoxes`/`ungroupSelectedBoxes` context functions
  - src/components/layout/Toolbar.tsx - Added Group and Ungroup buttons that appear conditionally based on selection state
  - src/components/viewport/Box3D.tsx - Added `groupIdToColor` hash function and colored outline (slightly scaled up lineSegments) for grouped boxes
- **Learnings for future iterations:**
  - `groupIdToColor` hashes a UUID string to a hue (0-360) for consistent group color across renders
  - Group visual indicator is a slightly scaled-up (1.03x) `lineSegments` with `edgesGeometry` using the group color — avoids `lineDashedMaterial` which requires `computeLineDistances()` on discontinuous edge segments
  - Toolbar uses `getSelectedBoxes()` to compute `canGroup` (2+ selected) and `canUngroup` (any selected have groupId)
  - `groupId` persists to IndexedDB automatically since it's a field on the Box object
---

## 2026-02-14 - US-005
- What was implemented: Multi-select delete and duplicate with relative position preservation
- Files changed:
  - src/store/projectStore.tsx - Replaced `findNonOverlappingPosition` (per-box) with `duplicateBoxGroup` (group-aware) for duplicate and paste operations. Group bounding box is computed, then the entire group is shifted as a unit to a non-overlapping position.
- **Learnings for future iterations:**
  - `duplicateBoxGroup` computes the bounding box of the source group, then slides the entire group along X to find a clear spot
  - Overlap checking tests every source box (at its offset position) against every existing box
  - Delete and copy already worked correctly for multi-select from US-001 — only duplicate/paste needed fixing for relative position preservation
---

## 2026-02-14 - US-004
- What was implemented: Multi-select move — dragging one selected box moves all selected boxes by the same XZ delta
- Files changed:
  - src/components/viewport/Box3D.tsx - Added `selectedBoxIds` and `onMoveSelected` props, multi-drag logic with start position tracking, click-vs-drag detection for multi-selection
  - src/components/viewport/Viewport.tsx - Added `handleMoveSelected` batch update handler, passes new props to Box3D
- **Learnings for future iterations:**
  - `dragStartPositions` ref stores initial positions of all selected boxes at pointer down
  - Delta is computed from the dragged box's snapped position vs its start position, then applied uniformly to all selected boxes
  - `didDrag` / `wasMultiSelected` / `pointerDownShift` refs used to distinguish click-to-select from drag-to-move
  - Auto-stacking excludes boxes in the dragged set (uses `draggedIds` Set) so dragged boxes don't stack on each other
  - On pointer down: if box is already selected in a multi-selection, selection is NOT replaced (to allow drag). On pointer up without drag, selection IS replaced to preserve standard click behavior
---

## 2026-02-14 - US-003
- What was implemented: Marquee (box) selection overlay for multi-selecting boxes by dragging on empty viewport area
- Files changed:
  - src/components/viewport/Viewport.tsx - Added CameraExposer component, marquee state/handlers, 2D overlay div, screen-space hit testing
- **Learnings for future iterations:**
  - CameraExposer component shares the R3F camera via a ref to code outside the Canvas
  - Box center is projected to screen space using Vector3.project(camera), then mapped to container-relative pixel coords
  - DRAG_THRESHOLD (5px) differentiates click-to-deselect from marquee drag
  - marqueeActive ref prevents background click handler from deselecting when marquee completes
  - Shift+marquee toggles boxes in/out of existing selection (XOR behavior)
  - OrbitControls with enableRotate=false doesn't conflict with left-click marquee (left button still mapped to rotate, which is a no-op)
---

## 2026-02-14 - US-002
- What was implemented: Added Shift+Click multi-select behavior to Box3D component
- Files changed:
  - src/components/viewport/Box3D.tsx - Added `onToggleSelect` prop, checks `e.shiftKey` in handlePointerDown to toggle vs replace selection
  - src/components/viewport/Viewport.tsx - Passes `toggleBoxSelection` from store as `onToggleSelect` prop to Box3D
- **Learnings for future iterations:**
  - ThreeEvent<PointerEvent> has `shiftKey` property just like native PointerEvent
  - Box3D uses `onSelect` for replace-selection and `onToggleSelect` for add/remove from selection
---

## 2026-02-14 - US-001
- What was implemented: Refactored selection model from single selectedBoxId to selectedBoxIds array
- Files changed:
  - src/store/projectStore.tsx - Changed state, actions, reducer, and context API
  - src/hooks/useSelection.ts - Updated to expose selectedBoxIds, selectedBoxes, selectBoxes, toggleBoxSelection, deselectAll
  - src/components/viewport/Viewport.tsx - Updated selection props passed to Box3D
  - src/components/layout/PropertiesPanel.tsx - Added multi-select summary view (count + bulk actions)
  - src/components/layout/BOMPanel.tsx - Updated highlight to use selectedBoxIds.includes
  - src/App.tsx - Updated keyboard shortcuts to use new multi-select APIs
- **Learnings for future iterations:**
  - The old `selectBox(null)` pattern becomes `selectBoxes([])`
  - PropertiesPanel shows full editor for single selection, summary for multi-select
  - Delete/Duplicate/Copy/Paste all operate on the full selectedBoxIds array now
  - Box3D component is not changed in this story — it still receives `isSelected` boolean prop
---

## 2026-02-14 - US-007
- What was implemented: Group-aware selection, move, delete, and duplicate — clicking any grouped box selects the entire group; Shift+Click toggles the entire group; duplicating preserves groups with new groupIds
- Files changed:
  - src/components/viewport/Box3D.tsx - Added `onSelectGroup`/`onToggleSelectGroup` props, computed `groupMemberIds` from `allBoxes`, removed `onSelect` prop (replaced by `onSelectGroup`), updated pointer handlers to expand selection to group members
  - src/components/viewport/Viewport.tsx - Passes `onSelectGroup` and `onToggleSelectGroup` callbacks, removed `onSelect` prop
  - src/store/projectStore.tsx - Updated `duplicateBoxGroup` to map old groupIds to new UUIDs so duplicated groups stay grouped
  - prd.json - Marked US-007 as passing
- **Learnings for future iterations:**
  - Group selection expansion happens at click time — move/delete/duplicate already work on `selectedBoxIds` so no changes needed there
  - `onSelect` was removed from Box3D since `onSelectGroup([singleId])` covers both grouped and ungrouped boxes
  - `onToggleSelectGroup` checks if all group members are already selected: if so, remove all; otherwise, add all
  - `duplicateBoxGroup` uses a `groupIdMap` (Map<oldId, newId>) to assign fresh UUIDs to duplicated groups
---

## 2026-02-14 - US-008
- What was implemented: Added `locked` field to Box type, TOGGLE_LOCK reducer action, Lock/Unlock buttons in both Toolbar and PropertiesPanel, and a lock icon overlay in the 3D viewport using Html from @react-three/drei
- Files changed:
  - src/types/index.ts - Added optional `locked?: boolean` field to Box interface
  - src/store/projectStore.tsx - Added TOGGLE_LOCK action type, reducer case (lock all if any unlocked, unlock all if all locked), `toggleLockSelectedBoxes` context function
  - src/components/layout/PropertiesPanel.tsx - Added Lock/Unlock button for both single and multi-select views
  - src/components/layout/Toolbar.tsx - Added Lock/Unlock button that appears when items are selected, styled amber when all locked
  - src/components/viewport/Box3D.tsx - Added Html import from drei, lock emoji overlay positioned at top-right corner of locked boxes
- **Learnings for future iterations:**
  - `Html` from @react-three/drei renders DOM elements in 3D space — use `style={{ pointerEvents: 'none' }}` to avoid interfering with box interactions
  - TOGGLE_LOCK uses "if any unlocked, lock all; else unlock all" pattern (same as bold/italic toggles in text editors)
  - `locked` persists to IndexedDB automatically since it's a field on the Box object
  - Lock icon positioned at `[box.dimensions.width, box.dimensions.height, 0]` to appear at the top-right corner
---

## 2026-02-14 - US-011
- What was implemented: Undo/redo toolbar buttons with arrow icons and Cmd+Z / Shift+Cmd+Z keyboard shortcuts
- Files changed:
  - src/components/layout/Toolbar.tsx - Added undo/redo buttons with left/right curved arrow SVG icons, disabled styling when canUndo/canRedo is false
  - src/App.tsx - Added Cmd+Z (undo) and Shift+Cmd+Z (redo) keyboard shortcuts with input field guard
  - prd.json - Marked US-011 as passing
- **Learnings for future iterations:**
  - Undo/redo buttons placed after Add Box area, before builder/component mode buttons — they're always visible regardless of mode
  - Shift+Cmd+Z must be checked before Cmd+Z in the if-else chain since Shift+Z also matches `e.key === 'z'`
  - Keyboard shortcuts guard against text input focus using `tagName === 'INPUT' || tagName === 'TEXTAREA'` check (existing pattern in App.tsx)
  - Buttons use `disabled` prop + conditional className for visual dimming when no undo/redo available
---
